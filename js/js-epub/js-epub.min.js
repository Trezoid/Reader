(function(a){var b=function(c){this.blob=c};a.JSEpub=b;b.prototype={unzipperConstructor:JSUnzip,inflater:JSInflate,processInSteps:function(c){c(1);this.unzipBlob();this.files={};this.uncompressNextCompressedFile(c)},unzipBlob:function(){var c=new this.unzipperConstructor(this.blob);if(!c.isZipFile()){throw new Error("Invalid EPUB archive format.")}c.readEntries();this.compressedFiles=c.entries},uncompressNextCompressedFile:function(d){var c=this;var e=this.compressedFiles.shift();if(e){d(2,e.fileName);this.uncompressFile(e);this.withTimeout(this.uncompressNextCompressedFile,d)}else{this.didUncompressAllFiles(d)}},withTimeout:function(e,d){var c=this;setTimeout(function(){e.call(c,d)},30)},didUncompressAllFiles:function(c){c(3);this.opfPath=this.getOpfPathFromContainer();this.readOpf(this.files[this.opfPath]);c(4);this.postProcess();c(5)},uncompressFiles:function(){this.files={};for(var d=0,c=this.entries.length;d<c;d++){this.uncompressFile(this.entries[d])}},uncompressFile:function(d){var c;if(d.compressionMethod===0){c=d.data}else{if(d.compressionMethod===8){c=this.inflater.inflate(d.data)}else{throw new Error("Unknown compression method "+d.compressionMethod+" encountered.")}}if(d.fileName==="META-INF/container.xml"){this.container=c}else{if(d.fileName==="mimetype"){this.mimetype=c}else{this.files[d.fileName]=c}}},getOpfPathFromContainer:function(){var c=this.xmlDocument(this.container);return c.getElementsByTagName("rootfile")[0].getAttribute("full-path")},readOpf:function(j){var o=this.xmlDocument(j);var m={metadata:{},manifest:{},spine:[]};var l=o.getElementsByTagName("metadata")[0].childNodes;for(var h=0,n=l.length;h<n;h++){var f=l[h];if(f.nodeType===3){continue}var p={};for(var g=0,c=f.attributes.length;g<c;g++){var k=f.attributes[g];p[k.name]=k.value}p._text=f.textContent;m.metadata[f.nodeName]=p}var d=o.getElementsByTagName("manifest")[0].getElementsByTagName("item");for(var h=0,n=d.length;h<n;h++){var f=d[h];m.manifest[f.getAttribute("id")]={href:this.resolvePath(f.getAttribute("href"),this.opfPath),"media-type":f.getAttribute("media-type")}}var e=o.getElementsByTagName("spine")[0].getElementsByTagName("itemref");for(var h=0,n=e.length;h<n;h++){var f=e[h];m.spine.push(f.getAttribute("idref"))}this.opf=m},resolvePath:function(g,c){var k=g.split("/");var j=k.pop();var h=c.split("/");h.pop();for(var f=0,e=k.length;f<e;f++){var d=k[f];if(d===".."){h.pop()}else{h.push(d)}}h.push(j);return h.join("/")},findMediaTypeByHref:function(c){for(key in this.opf.manifest){var e=this.opf.manifest[key];if(e.href===c){return e["media-type"]}}var d=c.match(/\.(\w+)$/);return d&&"image/"+d[1]},postProcess:function(){for(var f in this.opf.manifest){var d=this.opf.manifest[f]["media-type"];var e=this.opf.manifest[f]["href"];var c;if(d==="text/css"){c=this.postProcessCSS(e)}else{if(d==="application/xhtml+xml"){c=this.postProcessHTML(e)}}if(c!==undefined){this.files[e]=c}}},postProcessCSS:function(d){var e=this.files[d];var c=this;e=e.replace(/url\((.*?)\)/gi,function(h,g){if(/^data/i.test(g)){return h}else{var f=c.getDataUri(g,d);return"url("+f+")"}});return e},postProcessHTML:function(d){var h=decodeURIComponent(escape(this.files[d]));var o=this.xmlDocument(h);var k=o.getElementsByTagName("img");for(var g=0,n=k.length;g<n;g++){var f=k[g];var c=f.getAttribute("src");if(/^data/.test(c)){continue}f.setAttribute("src",this.getDataUri(c,d))}var m=o.getElementsByTagName("head")[0];var p=m.getElementsByTagName("link");for(var g=0,n=p.length;g<n;g++){var l=p[0];if(l.getAttribute("type")==="text/css"){var e=document.createElement("style");e.setAttribute("type","text/css");e.setAttribute("data-orig-href",l.getAttribute("href"));var j=this.files[this.resolvePath(l.getAttribute("href"),d)];e.appendChild(document.createTextNode(j));m.replaceChild(e,l)}}return o},getDataUri:function(f,d){var g=this.resolvePath(f,d);var c=this.findMediaTypeByHref(g);var e=escape(this.files[g]);return"data:"+c+","+e},validate:function(){if(this.container===undefined){throw new Error("META-INF/container.xml file not found.")}if(this.mimetype===undefined){throw new Error("Mimetype file not found.")}if(this.mimetype!=="application/epub+zip"){throw new Error("Incorrect mimetype "+this.mimetype)}},escapeData:function(c){return escape(c)},xmlDocument:function(c){var d=new DOMParser().parseFromString(c,"text/xml");if(d.childNodes[1]&&d.childNodes[1].nodeName==="parsererror"){throw d.childNodes[1].childNodes[0].nodeValue}return d}}}(this));
